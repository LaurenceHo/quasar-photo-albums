name: Build and deploy API for demo app

on:
  pull_request:
    branches:
      - master
    paths:
      - 'server/src/**'
      - 'server/package.json'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_FOR_GITHUB_DEPLOY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_FOR_GITHUB_DEPLOY }}
      AWS_REGION_NAME: ${{ secrets.AWS_REGION_NAME }}
      GOOGLE_PLACES_API_KEY: ${{ secrets.GOOGLE_PLACES_API_KEY }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      ALBUM_URL: ${{ vars.ALBUM_URL }}
      VITE_IMAGEKIT_CDN_URL: ${{ vars.VITE_IMAGEKIT_CDN_URL }}
      AWS_S3_BUCKET_NAME: ${{ vars.AWS_S3_BUCKET_NAME }}
      WORKER_URL: ${{ secrets.WORKER_URL }}
      WORKER_SECRET: ${{ secrets.DEV_WORKER_SECRET }}

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies and test
        run: |
          cd ./server
          bun install
          bun run types:server
          bun run test:server

      - name: Deploy Cloudflare Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_PHOTO_ALBUMS_WORKER: ${{ secrets.D1_PHOTO_ALBUMS_WORKER }}
          DEV_PHOTO_ALBUMS_DB_NAME: ${{ secrets.DEV_PHOTO_ALBUMS_DB_NAME }}
          DEV_PHOTO_ALBUMS_DB_ID: ${{ secrets.DEV_PHOTO_ALBUMS_DB_ID }}
          WORKER_SECRET: ${{ secrets.DEV_WORKER_SECRET }}
          # Dummy values for Prod vars to satisfy wrangler.toml validation
          PROD_PHOTO_ALBUMS_DB_NAME: 'placeholder-prod-db'
          PROD_PHOTO_ALBUMS_DB_ID: 'placeholder-prod-id'
        run: |
          # Go to the exact folder that contains wrangler.toml
          cd "$GITHUB_WORKSPACE/server"

          export DEV_PHOTO_ALBUMS_DB_NAME
          export DEV_PHOTO_ALBUMS_DB_ID
          export WORKER_SECRET

          # Substitute variables in wrangler.toml
          envsubst < wrangler.toml > wrangler.tmp.toml
          mv wrangler.tmp.toml wrangler.toml

          # Deploy
          npx wrangler deploy --name "$D1_PHOTO_ALBUMS_WORKER" --env=""
